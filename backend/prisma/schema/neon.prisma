// This schema is for user management and authentication on Neon PostgreSQL
// Labs and learning content are handled by local.prisma on local database

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma-user/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("NEON_DATABASE_URL")
  directUrl = env("NEON_DIRECT_DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  username      String          @unique
  password      String
  firstName     String?
  lastName      String?
  role          UserRole        @default(USER)
  avatar        String?
  bio           String?
  company       String?
  location      String?
  website       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastLoginAt   DateTime?
  recorded      Boolean         @default(false)
  
  // Relations for authentication
  api_keys      api_keys[]
  refreshTokens RefreshToken[]
  tokens        Token[]

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Token {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

model api_keys {
  id         String    @id
  name       String
  key        String    @unique
  scopes     String[]
  userId     String?
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  usageCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  users      User?     @relation(fields: [userId], references: [id])
  
  @@map("api_keys")
}

// ============================================
// SYSTEM LOGS (Optional - can be used for audit logging)
// ============================================

model system_logs {
  id        String   @id
  level     LogLevel
  message   String
  metadata  Json?
  userId    String?
  action    String?
  resource  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@map("system_logs")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
  LABCREATOR
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  ACCOUNT_ACTIVATION
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

