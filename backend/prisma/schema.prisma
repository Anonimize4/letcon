generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  username      String         @unique
  password      String
  firstName     String?
  lastName      String?
  role          UserRole       @default(USER)
  avatar        String?
  bio           String?
  company       String?
  location      String?
  website       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lastLoginAt   DateTime?
  apiKeys       ApiKey[]
  certificates  Certificate[]
  enrollments   Enrollment[]
  labSessions   LabSession[]
  refreshTokens RefreshToken[]
  tokens        Token[]
  progress      UserProgress[]

  @@map("users")
}

model LabCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String?
  color       String?
  labs        Lab[]

  @@map("lab_categories")
}

model Lab {
  id            String         @id @default(cuid())
  title         String
  description   String
  difficulty    Difficulty     @default(BEGINNER)
  dockerImage   String
  port          Int?
  environment   Json?
  instructions  String?
  hints         String[]
  flag          String?
  estimatedTime Int?
  tags          String[]
  categoryId    String
  objectives    String[]
  prerequisites String[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  certificates  Certificate[]
  enrollments   Enrollment[]
  labSessions   LabSession[]
  category      LabCategory    @relation(fields: [categoryId], references: [id])
  progress      UserProgress[]

  @@map("labs")
}

model LabSession {
  id          String        @id @default(cuid())
  userId      String
  labId       String
  containerId String?
  status      SessionStatus @default(RUNNING)
  startedAt   DateTime      @default(now())
  endedAt     DateTime?
  completedAt DateTime?
  progress    Float         @default(0)
  hintsUsed   Int           @default(0)
  timeSpent   Int           @default(0)
  ipAddress   String?
  userAgent   String?
  lab         Lab           @relation(fields: [labId], references: [id])
  user        User          @relation(fields: [userId], references: [id])

  @@map("lab_sessions")
}

model UserProgress {
  id             String         @id @default(cuid())
  userId         String
  labId          String
  status         ProgressStatus @default(NOT_STARTED)
  score          Float          @default(0)
  attempts       Int            @default(0)
  bestTime       Int?
  totalTime      Int            @default(0)
  firstAttemptAt DateTime?
  lastAttemptAt  DateTime?
  completedAt    DateTime?
  lab            Lab            @relation(fields: [labId], references: [id])
  user           User           @relation(fields: [userId], references: [id])

  @@unique([userId, labId])
  @@map("user_progress")
}

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  labId            String
  certificateUrl   String
  verificationCode String   @unique
  issuedAt         DateTime @default(now())
  lab              Lab      @relation(fields: [labId], references: [id])
  user             User     @relation(fields: [userId], references: [id])

  @@map("certificates")
}

model Enrollment {
  id         String    @id @default(cuid())
  userId     String
  labId      String
  enrolledAt DateTime  @default(now())
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  lab        Lab       @relation(fields: [labId], references: [id])
  user       User      @relation(fields: [userId], references: [id])

  @@unique([userId, labId])
  @@map("enrollments")
}

model SystemLog {
  id        String   @id @default(cuid())
  level     LogLevel
  message   String
  metadata  Json?
  userId    String?
  action    String?
  resource  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("system_logs")
}

model ApiKey {
  id         String    @id @default(cuid())
  name       String
  key        String    @unique
  scopes     String[]
  userId     String?
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  usageCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User?     @relation(fields: [userId], references: [id])

  @@map("api_keys")
}

model Token {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

enum UserRole {
  USER
  CREATOR
  ADMIN
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum SessionStatus {
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
  TERMINATED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  ACCOUNT_ACTIVATION
}
