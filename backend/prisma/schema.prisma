// Unified Prisma Schema for LETHCON Platform
// Combines user management, authentication, labs, and learning content

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION MODELS
// ============================================

model User {
  id            String          @id @default(cuid())
  email         String          @unique
  username      String          @unique
  password      String
  firstName     String?
  lastName      String?
  role          UserRole        @default(USER)
  avatar        String?
  bio           String?
  company       String?
  location      String?
  website       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lastLoginAt   DateTime?
  recorded      Boolean         @default(false)
  
  // Relations for authentication
  api_keys      ApiKey[]
  refreshTokens RefreshToken[]
  tokens        Token[]

  // Relations for labs and learning content
  labInstances  LabInstance[]
  submissions   ChallengeSubmission[]
  certificates  Certificate[]
  enrollments   Enrollment[]
  labSessions   LabSession[]
  userProgress  UserProgress[]
  achievements  UserAchievement[]

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Token {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

model ApiKey {
  id         String    @id
  name       String
  key        String    @unique
  scopes     String[]
  userId     String?
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  lastUsedAt DateTime?
  usageCount Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  user       User?     @relation(fields: [userId], references: [id])
  
  @@map("api_keys")
}

// ============================================
// LEARNING PATHS & CONTENT MODELS
// ============================================

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  description String?
  slug        String   @unique
  difficulty  Difficulty @default(BEGINNER)
  duration    Int?     // Duration in minutes
  isPublished Boolean  @default(false)
  isPremium   Boolean  @default(false)
  category    String?
  tags        String[]
  thumbnail   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  modules     LearningModule[]
  prerequisites LearningPath[] @relation("PathPrerequisites")
  dependentPaths LearningPath[] @relation("PathPrerequisites")
  
  @@map("learning_paths")
}

model LearningModule {
  id            String   @id @default(cuid())
  title         String
  description   String?
  order         Int
  duration      Int?     // Duration in minutes
  isPublished   Boolean  @default(false)
  learningPathId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  learningPath  LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  lessons       Lesson[]
  
  @@map("learning_modules")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  content     String   // Rich text content
  type        LessonType @default(THEORY)
  order       Int
  duration    Int?     // Duration in minutes
  moduleId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  module      LearningModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@map("lessons")
}

// ============================================
// LAB MODELS
// ============================================

model Lab {
  id             String          @id @default(cuid())
  title          String
  description    String
  slug           String?         @unique
  difficulty     Difficulty      @default(BEGINNER)
  duration       Int?
  isPublished    Boolean         @default(false)
  isPremium      Boolean         @default(false)
  tags           String[]
  thumbnail      String?
  dockerImage    String?
  port           Int?
  commands       Json?           // Lab commands as JSON
  environment    Json?           // Environment variables as JSON
  instructions   String?
  hints          String[]
  flag           String?
  estimatedTime  Int?
  objectives     String[]
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  // Relations
  challenges     Challenge[]
  instances      LabInstance[]
  prerequisites  Lab[]           @relation("LabPrerequisites")
  dependentLabs  Lab[]           @relation("LabPrerequisites")
  
  // Lab-specific relations
  certificates   Certificate[]
  enrollments    Enrollment[]
  labSessions    LabSession[]
  userProgress   UserProgress[]
  category       LabCategory?    @relation(fields: [categoryId], references: [id])
  categoryId     String?
  
  @@map("labs")
}

model Challenge {
  id          String   @id @default(cuid())
  title       String
  description String
  instructions String?
  solution    String?
  hints       String[]
  difficulty  Difficulty @default(BEGINNER)
  points      Int      @default(100)
  timeLimit   Int?     // Time limit in minutes
  labId       String
  order       Int
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  lab         Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  submissions ChallengeSubmission[]
  
  @@map("challenges")
}

model LabInstance {
  id           String   @id @default(cuid())
  userId       String
  labId        String
  status       LabStatus @default(PENDING)
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  expiresAt    DateTime?
  containerId  String?  // Docker container ID
  port         Int?     // Assigned port
  metadata     Json?    // Additional instance data
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab          Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  submissions  ChallengeSubmission[]
  
  @@unique([userId, labId])
  @@map("lab_instances")
}

model ChallengeSubmission {
  id           String   @id @default(cuid())
  userId       String
  challengeId  String
  labInstanceId String
  answer       String
  isCorrect    Boolean  @default(false)
  attempts     Int      @default(1)
  submittedAt  DateTime @default(now())
  metadata     Json?    // Submission metadata
  
  // Relations
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge    Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  labInstance  LabInstance @relation(fields: [labInstanceId], references: [id], onDelete: Cascade)
  
  @@map("challenge_submissions")
}

// ============================================
// USER-LAB RELATION MODELS
// ============================================

model Certificate {
  id               String   @id @default(cuid())
  userId           String
  labId            String
  title            String
  description      String
  certificateUrl   String?
  verificationCode String?  @unique
  issuedAt         DateTime @default(now())
  template         String?  // Certificate template URL
  criteria         Json?    // Certificate criteria as JSON
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user             User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab              Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  
  @@unique([userId, labId])
  @@map("certificates")
}

model Enrollment {
  id         String    @id @default(cuid())
  userId     String
  labId      String
  enrolledAt DateTime  @default(now())
  expiresAt  DateTime?
  isActive   Boolean   @default(true)
  
  // Relations
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab        Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  
  @@unique([userId, labId])
  @@map("enrollments")
}

model LabSession {
  id          String        @id @default(cuid())
  userId      String
  labId       String
  containerId String?
  status      SessionStatus @default(RUNNING)
  startedAt   DateTime      @default(now())
  endedAt     DateTime?
  completedAt DateTime?
  progress    Float         @default(0)
  hintsUsed   Int           @default(0)
  timeSpent   Int           @default(0)
  ipAddress   String?
  userAgent   String?
  
  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab         Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  
  @@map("lab_sessions")
}

model UserProgress {
  id             String         @id @default(cuid())
  userId         String
  labId          String
  status         ProgressStatus @default(NOT_STARTED)
  score          Float          @default(0)
  attempts       Int            @default(0)
  bestTime       Int?
  totalTime      Int            @default(0)
  firstAttemptAt DateTime?
  lastAttemptAt  DateTime?
  completedAt    DateTime?
  
  // Relations
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab            Lab @relation(fields: [labId], references: [id], onDelete: Cascade)
  
  @@unique([userId, labId])
  @@map("user_progress")
}

// ============================================
// ACHIEVEMENT MODELS
// ============================================

model Achievement {
  id          String   @id @default(cuid())
  title       String
  description String
  icon        String?
  badge       String?  // Badge image URL
  points      Int      @default(0)
  type        AchievementType @default(BRONZE)
  criteria    Json?    // Achievement criteria as JSON
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       UserAchievement[]
  
  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  earnedAt      DateTime @default(now())
  metadata      Json?
  
  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================
// CONTENT MANAGEMENT MODELS
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  slug        String   @unique
  parentId    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  @@map("categories")
}

model LabCategory {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  icon        String?
  color       String?
  
  // Relations
  labs        Lab[]
  
  @@map("lab_categories")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("system_config")
}

// ============================================
// SYSTEM LOGS
// ============================================

model SystemLog {
  id        String   @id
  level     LogLevel
  message   String
  metadata  Json?
  userId    String?
  action    String?
  resource  String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@map("system_logs")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  USER
  ADMIN
  LABCREATOR
}

enum TokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  ACCOUNT_ACTIVATION
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum LessonType {
  THEORY
  PRACTICAL
  QUIZ
  VIDEO
  READING
}

enum LabStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  EXPIRED
  STOPPED
}

enum AchievementType {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum SessionStatus {
  RUNNING
  COMPLETED
  FAILED
  TIMEOUT
  TERMINATED
}

